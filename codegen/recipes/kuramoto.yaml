model_name: Kuramoto
full_name: Kuramoto
citations:
  - Kuramoto et al. 1984 "Chemical Oscillations, Waves, and Turbulence"
  - Cabral et al. 2011 NeuroImage (10.1016/j.neuroimage.2011.04.010)
notes: |
  In Kuramoto model GPU and CPU results may differ under
  certain conditions (large G, presence of conduction delay, large
  sigma, etc.), especially when using larger dt.

  This discrepancy arises from subtle variations in mathematical
  function implementations between GPU and CPU hardware, which,
  depending on the system dynamics, can amplify through butterfly effects.

  As noted in NVIDIA's documentation
  (https://docs.nvidia.com/cuda/floating-point/index.html#considerations-for-a-heterogeneous-world),
  such differences do not indicate that either computation is incorrect.

  We therefore recommend to assess sensitivity of simulated
  findings in Kuramoto model (e.g. optimal simulation) to 
  CPU-based versus GPU-based simulations.

init_equations: |
  theta = init_theta

step_equations: |
  theta_dot = omega + G * globalinput
  theta = theta + dt * theta_dot + sqrt_dt * noise * sigma
  # Phase reset
  theta = fmod(theta, twopi)

conn_state_var: theta
is_osc: true

bold_state_var: theta

variables:
  - name: theta
    type: state_var
    description: phase angle
    
  - name: theta_dot
    type: intermediate_var
    description: phase velocity
    
  - name: G
    type: global_param
    description: global coupling strength
    # no default
    
  - name: init_theta
    type: regional_param
    description: initial phase angle
    # will be set randomly in Python

  - name: omega
    type: regional_param
    description: natural frequency
    value: np.pi

  - name: sigma
    type: regional_param
    description: noise amplitude
    value: 0.17

  - name: noise
    type: noise
    description: noise for theta

constants:
  - type: double
    name: dt
    value: dt
    description: integration step
    
  - type: double
    name: sqrt_dt
    value: sqrt(mc.dt)
    description: square root of integration step
    
  - type: double
    name: twopi
    value: 2.0 * M_PI
    description: ""

config:
  - type: bool
    name: random_init_theta
    value: "true"
    description: set initial theta by randomly sampling from a uniform distribution
    # only used in Python

# Python class generation configuration
python_config:
  sel_state_var: theta
    
  # TODO: labels

  custom_methods:
    post_init: |
      def post_init(self):
          print(
              "Warning: In Kuramoto model GPU and CPU results may differ under "
              "certain conditions (large G, presence of conduction delay, large "
              "sigma, etc.), especially when using larger dt.\n"
              "This discrepancy arises from subtle variations in mathematical "
              "function implementations between GPU and CPU hardware, which, "
              "depending on the system dynamics, can amplify through butterfly effects.\n"
              "As noted in NVIDIA's documentation "
              "(https://docs.nvidia.com/cuda/floating-point/index.html#considerations-for-a-heterogeneous-world), "
              "such differences do not indicate that either computation is incorrect.\n"
              "We therefore recommend to assess sensitivity of simulated "
              "findings in Kuramoto model (e.g. optimal simulation) to "
              "CPU-based versus GPU-based simulations."
          )

    N_setter: |
      @SimGroup.N.setter
      def N(self, N):
          super(KuramotoSimGroup, KuramotoSimGroup).N.__set__(self, N)
          if self.random_init_theta:
              # sample from uniform distribution of [0, 2*pi] across nodes and
              # repeat it across simulations
              # use the same random seed as the simulation noise
              rng = np.random.default_rng(self.sim_seed)
              self.param_lists["init_theta"] = np.tile(rng.uniform(0, 2 * np.pi, self.nodes), (self._N, 1))
          else:
              self.param_lists["init_theta"] = np.zeros((self._N, self.nodes), dtype=float)
              print("Warning: init_theta is set to zero")